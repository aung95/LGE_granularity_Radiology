---
title: "ICM LGE Granularity - Main script"
author: "Alexandre Unger"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: TRUE
    toc.depth : 2
    code_folding : "hide"
    keep_md: false
    fig_width: 7
    fig_height: 6
    fig_caption: true
---

```{r setup, include=FALSE}
library(knitr)
# Define the base directory
base_dir <- "/Users/alexandreunger/Documents/PROJECTS/ICM/ICM_tradi/RProject_ICM_tradi/outputs/figure_html"

# Get today's date and format it
today <- Sys.Date()
date_str <- format(today, "%Y-%m-%d")

# Construct the full directory path
fig_dir <- file.path(base_dir, date_str)

# Check if the directory exists, if not, create it
if (!dir.exists(fig_dir)) {
  dir.create(fig_dir, recursive = TRUE)
}

# Set knitr options with the absolute path
opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  dev = "png",
  dpi = 300,
  fig.path = fig_dir
)
```

# Code preparation
## Package installation.
Classified by type of package
```{r Packages}
library(rmarkdown)             # Documentation generation
library(officer)              # Manipulating Microsoft Word documents
library(flextable)            # Creating formatted tables in Microsoft Word documents
library(tableHTML)            # Creating tables in HTML format
library(gtsummary)            # Creating summary tables
library(here)                 # Dealing with file path

# ---- dealing with data
library(dplyr)                # Data manipulation and transformation
library(tidyr)                # Data tidying
library(DataExplorer)         # Exploratory data analysis
library(compareGroups)        # Comparing groups
library(psych)                # Psychological statistics and data manipulation
library(Hmisc)                # Miscellaneous functions for data analysis

# ---- Survival analysis
library(poptrend)             # Calculating p-trend in survival analysis
library(survival)             # Survival analysis
library(survivalAnalysis)     # Survival analysis functions
library(survminer)            # Drawing survival curves
library(adjustedCurves)       # Plotting adjusted survival curves
library(pammtools)            # Plotting adjusted survival curves
library(survIDINRI)           # Make reclassification and discrimination 
library(glmnet)               # Regularized regression models
library(olsrr)                # Variable selection at its best !

# ---- Graphics
library(ggplot2)              # Data visualization
library(mctest)               # Multiple hypothesis testing --> assess colinearity between continuous variable
library(corrplot)             # Visualizing correlation matrices
library(fmsb)                 # Creating radar plots
library(concreg)              # Plotting adjusted survival curves
library(ggpubr)               # Associating the risk table when plotting


# ---- My functions (located in the scrits/functions_R file)
source(here("functions_R","CoxPredictScore.R"))
source(here("functions_R","createSurvivalPlot.R"))
source(here("functions_R","process_data.R"))
source(here("functions_R","extract_model_stats.R"))
source(here("functions_R","forest_function.R"))
source(here("functions_R","uni_multi_function.R")) # function that does the table
```

## Data Download (RData).  
Using the data.management_ICM_Tradi_V4 results directly saved in RData. \n
* df_all : 6,082 patients \n
* df_LGE : 3,591 patients
* df_MACE : 1,500 patients with the informations
```{r loading file}
load(file = here("data","df_all.RData"))
load(file = here("data","df_LGE.RData"))
load(file = here("data","df_MACE.RData"))
```
## Creation of differents files
```{r files, message = TRUE}
library(here)

# Get today's date and format it as a string in the required format
date_suffix <- format(Sys.Date(), "%Y-%m-%d")

# Define the directory paths including the date with specified prefixes
tables_date_dir <- here("outputs", "tables", paste0("Tab-", date_suffix))
figures_date_dir <- here("outputs", "figures", paste0("Fig-", date_suffix))

# Check and create the "tables" date-specific directory if it doesn't exist
if (!dir.exists(tables_date_dir)) {
  dir.create(tables_date_dir, recursive = TRUE)
  message("Directory created: ", tables_date_dir)
} else {
  message("Directory already exists: ", tables_date_dir)
}

# Check and create the "figures" date-specific directory if it doesn't exist
if (!dir.exists(figures_date_dir)) {
  dir.create(figures_date_dir, recursive = TRUE)
  message("Directory created: ", figures_date_dir)
} else {
  message("Directory already exists: ", figures_date_dir)
}

# Save the directory paths for later use in the script
tables_output_dir <- tables_date_dir
figures_output_dir <- figures_date_dir

```

# All population (N=6,081)
## Descriptive
### Tab1-descr-all-LGE_presence
```{r Tab1-descr-all-LGE_presence}
Descr_table = createTable(compareGroups(
  CMR_LGE_ischemic_presence ~ 
    demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
    CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
    
    history_med_MI  + history_coronary_procedure + history_interv_PCI + 
    history_interv_CABG + med_periph_atheroma + history_stroke + 
    med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
    clini_cardiac_rythm + 
    
   outcome_revascularisation_90days +
    
    CMR_LVEF + CMR_LVEDV + 
    CMR_LVESV + CMR_LV_mass + CMR_RV_dysfunction + 
    
    CMR_LGE_presence_ischemic_and_midwall +
    
    CMR_LGE_ischemic_presence + 
    CMR_LGE_ischemic_extent_count +
    CMR_LGE_ischemic_extent_categ +
    CMR_LGE_ischemic_transmurality +
    CMR_LGE_ischemic_location_4 +
    
    CMR_LGE_ischemic_anterior + 
    CMR_LGE_ischemic_septal +
    CMR_LGE_ischemic_inferior +
    CMR_LGE_ischemic_lateral +
    CMR_LGE_ischemic_Apical +
    
    CMR_LGE_midwall_presence +
    CMR_LGE_midwall_extent_count + 
    CMR_LGE_midwall_extent_categ +
    CMR_LGE_midwall_location_3 + 
    CMR_LGE_midwall_location_4 +
    CMR_LGE_midwall_anterior +
    CMR_LGE_midwall_septal +
    CMR_LGE_midwall_inferior +
    CMR_LGE_midwall_lateral +
    CMR_LGE_midwall_apical,
  data= df_all,
  method = 1, conf.level = 0.995),
  hide.no = "No",
  show.all=T, show.p.overall = T) 

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab1-descr-all-LGE_presence-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)


```
### Tab2-descr-all-center
```{r Tab2-descr-all-center}
Descr_table = createTable(compareGroups(
    demo_center ~ 
    demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
    CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
    
    history_med_MI  + history_coronary_procedure + history_interv_PCI + 
    history_interv_CABG + med_periph_atheroma + history_stroke + 
    med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
    clini_cardiac_rythm + 
    
   outcome_revascularisation_90days +
    
    CMR_LVEF + CMR_LVEDV + 
    CMR_LVESV + CMR_LV_mass + CMR_RV_dysfunction + 
    
    CMR_LGE_presence_ischemic_and_midwall +
    
    CMR_LGE_ischemic_presence + 
    CMR_LGE_ischemic_extent_count +
    CMR_LGE_ischemic_extent_categ +
    CMR_LGE_ischemic_transmurality +
    CMR_LGE_ischemic_location_4 +
    
    CMR_LGE_ischemic_anterior + 
    CMR_LGE_ischemic_septal +
    CMR_LGE_ischemic_inferior +
    CMR_LGE_ischemic_lateral +
    CMR_LGE_ischemic_Apical +
    
    CMR_LGE_midwall_presence +
    CMR_LGE_midwall_extent_count + 
    CMR_LGE_midwall_extent_categ +
    CMR_LGE_midwall_location_3 + 
    CMR_LGE_midwall_location_4 +
    CMR_LGE_midwall_anterior +
    CMR_LGE_midwall_septal +
    CMR_LGE_midwall_inferior +
    CMR_LGE_midwall_lateral +
    CMR_LGE_midwall_apical,
  data= df_all,
  method = 1, conf.level = 0.995),
  hide.no = "No",
  show.all=T, show.p.overall = T) 

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab2-descr-all-center-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab3-descr-all-death
```{r Tab3-descr-all-death}

df_selected <- df_all %>% mutate(
  outcome_death = as.factor(outcome_death),
  outcome_MACE = as.factor(outcome_MACE ),
  outcome_MACE_CV_death = as.factor(outcome_MACE_CV_death),
  outcome_MACE_NonFatal_MI = as.factor(outcome_MACE_NonFatal_MI)
)

Descr_table = createTable(compareGroups(
    outcome_death ~ 
      
    outcome_revascularisation_90days + outcome_death + outcome_MACE + outcome_MACE_CV_death + outcome_MACE_NonFatal_MI +
      
    demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
    CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
    
    history_med_MI  + history_coronary_procedure + history_interv_PCI + 
    history_interv_CABG + med_periph_atheroma + history_stroke + 
    med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
    clini_cardiac_rythm + 
    
   outcome_revascularisation_90days +
    
    CMR_LVEF + CMR_LVEDV + 
    CMR_LVESV + CMR_LV_mass + CMR_RV_dysfunction + 
    
    CMR_LGE_presence_ischemic_and_midwall +
    
    CMR_LGE_ischemic_presence + 
    CMR_LGE_ischemic_extent_count +
    CMR_LGE_ischemic_extent_categ +
    CMR_LGE_ischemic_transmurality +
    CMR_LGE_ischemic_location_4 +
    
    CMR_LGE_ischemic_anterior + 
    CMR_LGE_ischemic_septal +
    CMR_LGE_ischemic_inferior +
    CMR_LGE_ischemic_lateral +
    CMR_LGE_ischemic_Apical +
    
    CMR_LGE_midwall_presence +
    CMR_LGE_midwall_extent_count + 
    CMR_LGE_midwall_extent_categ +
    CMR_LGE_midwall_location_3 + 
    CMR_LGE_midwall_location_4 +
    CMR_LGE_midwall_anterior +
    CMR_LGE_midwall_septal +
    CMR_LGE_midwall_inferior +
    CMR_LGE_midwall_lateral +
    CMR_LGE_midwall_apical,
  data= df_selected,
  method = 1, conf.level = 0.995),
  hide.no = "No",
  show.all=T, show.p.overall = T) 

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab3-descr-all-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
## Survival
### Tab4-univ-all-death
```{r Tab4-univ-all-death}
df_selected <- df_all %>%
  mutate(
    surv.event = Surv(
      time = outcome_FU_time_death,
      event = outcome_death
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  )

Descr_table = createTable(compareGroups(
  surv.event ~ 
    demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
    CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
    
    history_med_MI  + history_coronary_procedure + history_interv_PCI + 
    history_interv_CABG + med_periph_atheroma + history_stroke + 
    med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
    clini_cardiac_rythm + 
    
   outcome_revascularisation_90days +
    
    CMR_LVEF_5 + CMR_LVEDV_5 + 
    CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
    
    CMR_LGE_presence_ischemic_and_midwall +
    
    CMR_LGE_ischemic_presence + 
    CMR_LGE_ischemic_extent_count +
    CMR_LGE_ischemic_extent_categ +
    CMR_LGE_ischemic_transmurality +
    CMR_LGE_ischemic_location_4 +
    
    CMR_LGE_ischemic_anterior + 
    CMR_LGE_ischemic_septal +
    CMR_LGE_ischemic_inferior +
    CMR_LGE_ischemic_lateral +
    CMR_LGE_ischemic_Apical +
    
    CMR_LGE_midwall_presence +
    CMR_LGE_midwall_extent_count + 
    CMR_LGE_midwall_extent_categ +
    CMR_LGE_midwall_location_3 + 
    CMR_LGE_midwall_location_4 +
    CMR_LGE_midwall_anterior +
    CMR_LGE_midwall_septal +
    CMR_LGE_midwall_inferior +
    CMR_LGE_midwall_lateral +
    CMR_LGE_midwall_apical,
  data= df_selected,
  method = 1, conf.level = 0.995),
  hide.no = "No",
  show.ratio =T, show.p.ratio =  T) 

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab4-univ-all-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab5-multi_tradi-all-death
```{r Tab5-multi_tradi-all-death}
df <- df_all %>% mutate(
  event = outcome_death,
  time = outcome_FU_time_death,
  CMR_LVEF_5 = CMR_LVEF/5
) %>% select(
  event, time,
  demo_age, demo_gender, demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF, history_AFib, med_CKD, history_med_MI , CMR_LVEF_5, CMR_LGE_ischemic_presence) %>% droplevels()

#### TABLE 

## Model 1
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LVEF_5))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 1", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 2
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 2", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Table uni multi 
table <- uni_multi_function(
  df = df, 
  event = "event",
  time = "time", 
  var_base = c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5"), 
  var_added = c("CMR_LGE_ischemic_presence"))

# export in html
knitr::kable(table, caption = "Model 2 - LGE presence - All population", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Export in word
ft <- flextable(table)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Model 3 - LGE presence in all pop (N=6,082)", style = "heading 1") %>%
  body_add_flextable(ft)
print(doc, target = here(tables_output_dir,paste0("Tab5-multi_tradi-all-death-",Sys.Date(), ".docx")))


```
### Tab6-incr-all-death
```{r Tab6-incr-all-death}
var1 <- c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF")
var2 <- c(var1, "CMR_LGE_ischemic_presence")

df <- df_all %>% mutate(
  time = outcome_FU_time_death,
  event = outcome_death
)%>% droplevels()

# MODEL 1
results.model1 <- CoxPredictScore(derivation = df, validation = df,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var1, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model1$model_stats
results.model1$derivation$auc

# MODEL 2
results.model2 <- CoxPredictScore(derivation = df, validation = df,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var2, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model2$model_stats
results.model2$derivation$auc

roc.test(results.model1$roc_derivation$roc_obj, results.model2$roc_derivation$roc_obj)


```

## Figures
### Fig1-all-KM-LGE_presence
```{r Fig1-all-KM-LGE_presence}
# Data parameters
results <- createSurvivalPlot(
  data = df_all,
  compared_with = "CMR_LGE_ischemic_presence",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors = c("#25A26B","#FF002B"),
  confint_choosen = 0.995,
  mytitle = "Fig1: LGE presence (all pop = 6,082)"
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig1-all-KM-LGE_presence_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig1-all-KM-LGE_presence_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)


```

### Fig2-all-KM-LGE_presence_multi
```{r Fig2-all-KM-LGE_presence_multi}
# Data parameters
df_selected <- df_all %>%
  select(
    outcome_FU_time_death, outcome_death,
    CMR_LGE_ischemic_presence,
    demo_age, demo_gender , demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF , history_AFib , med_CKD , history_med_MI , CMR_LVEF
  )  %>%
  mutate(
    outcome_FU_time_death = outcome_FU_time_death/12
  ) %>% filter(
    outcome_FU_time_death <= 9
  )

summary(df_selected$outcome_FU_time_death)

# statistics parameters
confint_choosen = 0.995
P_vizu = TRUE # To check log rank for all KM graphs

# Graphics viz
legend_title <- c("Ischemic LGE")
my_legends <- c("Absence of LGE","Presence of LGE")
mytitle <- c("Fig 1C - LGE MULTI - ALL (N=6082)")
my_colors <- c("#25A26B","#FF002B")
size_font = 12
ylim_choosen = c(0.5,1) 
xlim_choosen = c(0,13)

#### ------------------------ ####
library(riskRegression)
model <- coxph(formula = Surv(outcome_FU_time_death, outcome_death) ~ CMR_LGE_ischemic_presence + demo_age+ demo_gender + demo_BMI + CV_risk_diabete + CV_risk_Smoking + CV_risk_dyslipidemia +  history_hospit_HF + history_AFib + med_CKD + history_med_MI + CMR_LVEF, data = df_selected, x = TRUE)


adjsurv <- adjustedsurv(data=df_selected, # utilisation de ce filtre pour ne pas avoir l'ensemble de la courbe
                        variable="CMR_LGE_ischemic_presence",
                        ev_time="outcome_FU_time_death",
                        event="outcome_death",
                        method="direct",
                        outcome_model=model,
                        conf_int=TRUE,
                        conf_level = 0.995,
                        colors = TRUE,
                        custom_colors = my_colors,
                        ggtheme = theme_bw())


# plot with confidence intervals
gg <- plot(adjsurv, 
     main = mytitle,
     legend.title = NULL,
     legend.position = "none",
     conf_int = TRUE,
     censoring_ind = "lines",
     xlab = "years of follow-up",
     ylab = "Adjusted survival probability",
     xlim = c(0, 12),
     ylim = c(0.5, 1),
     custom_colors = my_colors,
     ggtheme = theme_bw()) +
  scale_x_continuous(breaks = seq(0, 12, 2),
                     labels = seq(0, 12, 2)) +
  theme(axis.text = element_text(size = size_font),  # Adjust the font size of the axis labels
        axis.title = element_text(size = size_font + 2),  # Adjust the font size of the axis titles
        axis.line = element_line(size = 0.1), # reduced size of axis
        legend.text = element_text(size = size_font + 4),  # Adjust the font size of the legend text
        legend.title = element_text(size = size_font + 6),  # Adjust the font size of the legend title
        panel.border = element_rect(color = "black", fill = NA, size = 0.3),
        panel.background = element_rect(fill = "white"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank())

gg

ggsave(
  filename = here(figures_output_dir, paste0("Fig2-all-KM-LGE_presence_multi-", Sys.Date(),".png")), 
  plot = gg, width = 10, height = 6, units = "in", dpi = 600)


```
### Fig3-all-KM-LGE_FEVG_plot
```{r Fig3-all-KM-LGE_FEVG_plot}
# Data parameters
df_selected <- df_all %>%
  mutate(
    FEVG_LGE = case_when(
      CMR_LGE_ischemic_presence == "No_ischemic_LGE" & CMR_LVEF > 40 ~ "A LGE - ; FEVG ≥ 40",
      CMR_LGE_ischemic_presence == "No_ischemic_LGE" & CMR_LVEF <= 40 ~ "B LGE - ; FEVG < 40",
      CMR_LGE_ischemic_presence == "Presence_of_ischemic_LGE" & CMR_LVEF > 40 ~ "C LGE + ; FEVG ≥ 40",
      CMR_LGE_ischemic_presence == "Presence_of_ischemic_LGE" & CMR_LVEF <= 40 ~ "D LGE + ; FEVG < 40",
      TRUE ~ NA_character_
    )
  )

# Data parameters
results <- createSurvivalPlot(
  data = df_selected,
  compared_with = "FEVG_LGE",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors = c("#25A26B","#4292C6","#FF002B","#2C3E50"),
  confint_choosen = 0.995,
  mytitle = "Fig4: LGE type (all pop = 6,082)"
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig3-all-KM-LGE_FEVG_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig3-all-KM-LGE_FEVG_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```

### Fig4-all-KM-LGE_type
```{r Fig4-all-KM-LGE_type}
# Data parameters
results <- createSurvivalPlot(
  data = df_all,
  compared_with = "CMR_LGE_type",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors = c("#25A26B","#4292C6","#FF002B","#2C3E50"),
  confint_choosen = 0.995,
  mytitle = "Fig4: LGE type (all pop = 6,082)"
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig4-all-KM-LGE_type_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig4-all-KM-LGE_type_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```
### KM Revascularization
#### Fig5-all-KM-revasc - in modif
```{r Fig5-all-KM-revasc}
results <- createSurvivalPlot(
  data = df_all,
  compared_with = "outcome_revascularisation_90days",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  confint_choosen = 0.995,
  legend_title = "Fig revasc pop = 6,082"
)

results$HR
results$ggsurv

ggsave(
  filename = here(figures_output_dir, paste0("Fig5-all-KM-revasc_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig5-all-KM-revasc_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```
#### Fig6-all-KM-revasc_viability - in modif
```{r Fig6-all-KM-revasc_viability}
# Modification of the dataset
df_selected <- df_all %>%
  mutate(
  CMR_LGE_Viable = case_when(
    CMR_LGE_ischemic_transmurality == "B_Subendocardial<50%" ~ 1,
    CMR_LGE_ischemic_transmurality == "C_Subendocardial≥50%" | CMR_LGE_ischemic_transmurality == "D_Transmural" ~ 2,
    TRUE ~ 3),
  CMR_LGE_Viable = factor(
    CMR_LGE_Viable, levels = c(1,2,3), labels = c("Viable","NonViable","NoLGE")
  ),
  CMR_LGE_Viable_Revasc = case_when(
    CMR_LGE_Viable == "Viable" & outcome_revascularisation_90days == "Yes" ~ 1,
    CMR_LGE_Viable == "Viable" & outcome_revascularisation_90days == "No" ~ 2,
    CMR_LGE_Viable == "NonViable" & outcome_revascularisation_90days == "Yes" ~ 3,
    CMR_LGE_Viable == "NonViable" & outcome_revascularisation_90days == "No" ~ 4,
    TRUE ~ 0),
  CMR_LGE_Viable_Revasc = factor(
    CMR_LGE_Viable_Revasc, levels = c(0,1,2,3,4), labels = c("No_LGE","Viable_Revasc","viable_NonRevasc","NonViable_Revasc","NonViable_NonRevasc")
  )
  )

results <- createSurvivalPlot(
  data = df_selected,
  compared_with = "CMR_LGE_Viable_Revasc",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  confint_choosen = 0.995,
  legend_title = "Fig revasc pop = 6,082",
  my_colors = c("#006400", "darkblue", "#FF0000", "#8B4513", "#000000"),
  show.CI = FALSE
)

results$HR
results$ggsurv


# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig6-all-KM-revasc_viability_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig6-all-KM-revasc_viability_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```

### Fig7-all-corrplot
```{r correlation all in LGE }
# Select specific columns for correlation analysis
df_selected <- df_LGE %>%
  mutate_if(is.factor, ~ as.numeric(.)) %>%
  select(demo_NIP:CMR_LGE_ischemic_presence) %>%
  select(-outcome_death, -outcome_FU_time_death, -CMR_LGE_presence_ischemic_or_midwall, -demo_NIP, -demo_center)

# Calculate the correlation matrix and round the values
correlation_matrix <- cor(df_selected)

# Set the threshold for identifying highly correlated features
threshold <- 0.7

# Find highly correlated feature pairs
correlation_pairs <- which(correlation_matrix > threshold & correlation_matrix < 1, arr.ind = TRUE)

# Extract the names and correlation values of the most collinear features
most_collinear_features <- data.frame(
  Feature1 = rownames(correlation_matrix)[correlation_pairs[, 1]],
  Feature2 = colnames(correlation_matrix)[correlation_pairs[, 2]],
  Correlation_Value = correlation_matrix[correlation_pairs]
)
# Sort by correlation value in descending order
most_collinear_features <- most_collinear_features[order(-most_collinear_features$Correlation_Value), ]
print(most_collinear_features)

# Create a color palette for the plot
color_palette <- colorRampPalette(c("blue", "black", "red"))(50)

# Create an attractive correlation plot
correlation_matrix <- cor(df_selected[, unique(most_collinear_features$Feature1)])

corrplot(correlation_matrix,
         method = "number",   # Display correlation values
         type = "upper",      # Display only the upper triangle
         col = color_palette, # Set the color palette
         tl.cex = 0.8,        # Adjust text label size
         tl.col = "black",    # Set text label color
         cl.ratio = 0.2,      # Adjust the space for the color legend
         number.cex = 0.7,    # Adjust correlation value size
         addCoef.col = "black" # Set coefficient color
)

correlation_matrix <- cor(df_selected)

corrplot(correlation_matrix,
         method = "color",
         type = "full",
         tl.col = "black",
         addCoefasPercent = FALSE # Remove value display
)

corrplot(correlation_matrix,
                      method = "color",
                      type = "full",
                      tl.col = "black",
                      addCoefasPercent = FALSE)  # Removes value display

# Saving the plot
# # Note: 'corr_plot' does not need to be assigned or used with 'plot = c' in ggsave
# ggsave(
#   filename = here("outputs", "figures", paste0("Fig7-all-corrplot-", Sys.Date(), ".png")),
#   plot = corr_plot,  # Saves the last plot
#   width = 10,
#   height = 3,
#   units = "in",
#   dpi = 600
# )
```

# LGE population (N=3,591)
## Survival
### Tab7-univ-LGE-death
```{r Tab7-univ-LGE-death}
df_selected <- df_LGE %>%
  mutate(
    surv.event = Surv(
      time = outcome_FU_time_death,
      event = outcome_death
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  )

Descr_table = createTable(compareGroups(
  surv.event ~ 
    demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
    CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
    
    history_med_MI  + history_coronary_procedure + history_interv_PCI + 
    history_interv_CABG + med_periph_atheroma + history_stroke + 
    med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
    clini_cardiac_rythm + 
    
   outcome_revascularisation_90days +
    
    CMR_LVEF_5 + CMR_LVEDV_5 + 
    CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
    
    CMR_LGE_presence_ischemic_and_midwall +
    
    CMR_LGE_ischemic_presence + 
    CMR_LGE_ischemic_extent_count +
    CMR_LGE_ischemic_extent_categ +
    CMR_LGE_ischemic_transmurality +
    CMR_LGE_ischemic_location_4 +
    
    CMR_LGE_ischemic_anterior + 
    CMR_LGE_ischemic_septal +
    CMR_LGE_ischemic_inferior +
    CMR_LGE_ischemic_lateral +
    CMR_LGE_ischemic_Apical +
    
    CMR_LGE_midwall_presence +
    CMR_LGE_midwall_extent_count + 
    CMR_LGE_midwall_extent_categ +
    CMR_LGE_midwall_location_3 + 
    CMR_LGE_midwall_location_4 +
    CMR_LGE_midwall_anterior +
    CMR_LGE_midwall_septal +
    CMR_LGE_midwall_inferior +
    CMR_LGE_midwall_lateral +
    CMR_LGE_midwall_apical,
  data= df_selected,
  method = 1, conf.level = 0.995),
  hide.no = "No",
  show.ratio=T, show.p.ratio = T) 

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab7-univ-LGE-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab8-multi_tradi-LGE-death
```{r Tab8-multi_tradi-LGE-death}
df <- df_LGE %>% mutate(
  event = outcome_death,
  time = outcome_FU_time_death,
  CMR_LVEF_5 = CMR_LVEF/5
) %>% select(
  event, time,
  demo_age, demo_gender, demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF, history_AFib, med_CKD, history_med_MI , CMR_LVEF_5, CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_transmurality, CMR_LGE_ischemic_location_4, CMR_LGE_midwall_presence, outcome_revascularisation_90days) %>% droplevels()

#### TABLE 

## Model 1
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LVEF_5))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 1", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 2
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 2", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","model2_LGE_tradi.csv"), append = FALSE)


## Model 3A
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_transmurality))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3A", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


## Model 3B
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_location_4))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3B", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))
## Model 3C
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3C", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


## Model 4
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","model4_LGE_tradi.csv"), append = FALSE)

## Model 5
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: outcome_revascularisation_90days))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","model5_LGE_tradi.csv"), append = FALSE)

## MODELS MULTI NESTED
var_base = c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5")

### Nested 4
table <- uni_multi_function(
  df = df, 
  event = "event",
  time = "time", 
  var_base = var_base, 
  var_added = c("CMR_LGE_ischemic_extent_count", "CMR_LGE_ischemic_transmurality","CMR_LGE_ischemic_location_4",
                "CMR_LGE_midwall_presence", "outcome_revascularisation_90days"))

# export in html
knitr::kable(table, caption = "Model full - granularity until revasc (LGE pop = 3,591)", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Export in word
ft <- flextable(table)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Model 4 - LGE pop (N=3,591)", style = "heading 1") %>%
  body_add_flextable(ft)
print(doc, target = here(tables_output_dir,paste0("Tab8-multi_tradi-LGE-death-",Sys.Date(), ".docx")))


```
### Tab9-multi_stepwise-LGE-death OK
```{r Tab9-multi_stepwise-LGE-death}
library(dplyr)
library(StepReg)
library(survival)

# Assuming df_LGE is your initial dataset
df_selected <- df_all %>% 
  mutate_if(is.factor, as.numeric) %>% mutate(
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVESV_10 = CMR_LVESV/10,
    CMR_LVEDV_10 = CMR_LVEDV/10
  ) %>%
  select(outcome_death, outcome_FU_time_death,
         demo_age, demo_gender, demo_BMI, CV_risk_diabete, CV_risk_obesity, CV_risk_dyslipidemia,
         CV_risk_Smoking, history_med_MI, history_coronary_procedure, history_interv_PCI, history_interv_CABG, med_periph_atheroma, history_stroke, med_pacemaker, med_CKD, history_hospit_HF, history_AFib, clini_NYHA,
         clini_cardiac_rythm, CMR_LVEF_5, CMR_LVESV_10, CMR_LVEDV_10,
         CMR_LV_mass, CMR_RV_dysfunction) # CV_risk_HTA

# Define the Cox model formula
formula <- Surv(outcome_FU_time_death, outcome_death) ~ .

# Run stepwise Cox regression
stepwise_result <- stepwiseCox(
  formula = formula,
  data = df_selected,
  sle = 0.1,
  sls = 0.1,
  selection = "forward",  # Choose your selection method
  select = "SL" #,              # Choose your selection criterion
  # method = "Breslow"            # Choose your method for tie handling "Efron"
)

# View the results
summary(stepwise_result)
var_select <- as.data.frame(t(stepwise_result$`Selected Varaibles`[1,]))$xModel
var_select


#### Multivariable analysis
# taking the LGE variables into account 
df <- df_LGE %>% mutate(
  event = outcome_death,
  time = outcome_FU_time_death,
  CMR_LVEF_5 = CMR_LVEF/5
) %>% select(
  event, time,
  var_select, CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_transmurality, CMR_LGE_ischemic_location_4, CMR_LGE_midwall_presence, outcome_revascularisation_90days) %>% droplevels()

#### TABLE 

## Model 1
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CV_risk_Smoking))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model stepwise 1", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","model1_stepwise.csv"), append = FALSE)

## Model 2
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model stepwise 2", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3A
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_transmurality))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model stepwise 3A", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3B
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_location_4))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model stepwise 3B", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3C
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model stepwise 3C", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 4
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model stepwise 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","model4_stepwise.csv"), append = FALSE)

## model uni - multi
table <- uni_multi_function(
  df = df, 
  event = "event",
  time = "time", 
  var_base = var_select, 
  var_added = c("CMR_LGE_ischemic_extent_count", "CMR_LGE_ischemic_transmurality","CMR_LGE_ischemic_location_4",
                "CMR_LGE_midwall_presence", "outcome_revascularisation_90days"))

# export in html
knitr::kable(table, caption = "Model 4 - granularity + revasc (LGE pop = 3,591)", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


# Export in word
ft <- flextable(table)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Model full - LGE pop (N=3,591)", style = "heading 1") %>%
  body_add_flextable(ft)

print(doc, target = here(tables_output_dir,paste0("Tab9-multi_stepwise-LGE-death-",Sys.Date(), ".docx")))
```

### Tab10-incr_tradi-LGE-death
```{r Tab10-incr_tradi-LGE-death}
var1 <- c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5")
var2 <- c(var1, "CMR_LGE_ischemic_extent_count")
var3A <- c(var2, "CMR_LGE_ischemic_transmurality")
var3B <- c(var2, "CMR_LGE_ischemic_location_4")
var3C <-  c(var2, "CMR_LGE_midwall_presence")
var4 <- c(var2, "CMR_LGE_ischemic_transmurality", "CMR_LGE_ischemic_location_4", "CMR_LGE_midwall_presence")

df_LGE <- df_LGE %>% mutate(
  time = outcome_FU_time_death,
  event = outcome_death,
  CMR_LVEF_5 = CMR_LVEF/5
)%>% droplevels()

# MODEL 1
results.model1 <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var1, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model1$model_stats
results.model1$derivation$auc

# MODEL 2
results.model2 <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var2, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model2$model_stats
results.model2$derivation$auc

roc.test(results.model1$roc_derivation$roc_obj, results.model2$roc_derivation$roc_obj)

# MODEL 3A
results.model3A <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3A, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3A$model_stats
results.model3A$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3A$roc_derivation$roc_obj)

# MODEL 3B
results.model3B <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3B, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3B$model_stats
results.model3B$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3B$roc_derivation$roc_obj)

# MODEL 3C
results.model3C <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3C, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3C$model_stats
results.model3C$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3C$roc_derivation$roc_obj)

# MODEL 4
results.model4 <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var4, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model4$model_stats
results.model4$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)

# incremental between model 4 and model 3ABC
roc.test(results.model3A$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)
roc.test(results.model3B$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)
roc.test(results.model3C$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)

```
### Tab11-incr_stepwise-LGE-death
```{r Tab11-incr_stepwise-LGE-death}
# Assuming df_LGE is your initial dataset
df_selected <- df_all %>% 
  mutate_if(is.factor, as.numeric) %>% mutate(
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVESV_10 = CMR_LVESV/10,
    CMR_LVEDV_10 = CMR_LVEDV/10
  ) %>%
  select(outcome_death, outcome_FU_time_death,
         demo_age, demo_gender, demo_BMI, CV_risk_diabete, CV_risk_obesity, CV_risk_dyslipidemia,
         CV_risk_Smoking, history_med_MI, history_coronary_procedure, history_interv_PCI, history_interv_CABG, med_periph_atheroma, history_stroke, med_pacemaker, med_CKD, history_hospit_HF, history_AFib, clini_NYHA,
         clini_cardiac_rythm, CMR_LVEF_5, CMR_LVESV_10, CMR_LVEDV_10,
         CMR_LV_mass, CMR_RV_dysfunction) # CV_risk_HTA

# Define the Cox model formula
formula <- Surv(outcome_FU_time_death, outcome_death) ~ .

# Run stepwise Cox regression
stepwise_result <- stepwiseCox(
  formula = formula,
  data = df_selected,
  sle = 0.1,
  sls = 0.1,
  selection = "forward",  # Choose your selection method
  select = "SL" #,              # Choose your selection criterion
  # method = "Breslow"            # Choose your method for tie handling "Efron"
)

# View the results
summary(stepwise_result)
var_select <- as.data.frame(t(stepwise_result$`Selected Varaibles`[1,]))$xModel
var_select

# View the results
summary(stepwise_result)
var1 <- as.data.frame(t(stepwise_result$`Selected Varaibles`[1,]))$xModel # on prend les résultats du stepwise
var2 <- c(var1, "CMR_LGE_ischemic_extent_count")
var3A <- c(var2, "CMR_LGE_ischemic_transmurality")
var3B <- c(var2, "CMR_LGE_ischemic_location_4")
var3C <-  c(var2, "CMR_LGE_midwall_presence")
var4 <- c(var2, "CMR_LGE_ischemic_transmurality", "CMR_LGE_ischemic_location_4", "CMR_LGE_midwall_presence")

df_LGE <- df_LGE %>% mutate(
  time = outcome_FU_time_death,
  event = outcome_death,
  CMR_LVEF_5 = CMR_LVEF/5,
)%>% droplevels()

# MODEL 1
results.model1 <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var1, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model1$model_stats
results.model1$derivation$auc

# MODEL 2
results.model2 <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var2, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model2$model_stats
results.model2$derivation$auc

roc.test(results.model1$roc_derivation$roc_obj, results.model2$roc_derivation$roc_obj)

# MODEL 3A
results.model3A <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3A, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3A$model_stats
results.model3A$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3A$roc_derivation$roc_obj)

# MODEL 3B
results.model3B <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3B, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3B$model_stats
results.model3B$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3B$roc_derivation$roc_obj)

# MODEL 3C
results.model3C <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3C, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3C$model_stats
results.model3C$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3C$roc_derivation$roc_obj)

# MODEL 4
results.model4 <- CoxPredictScore(derivation = df_LGE, validation = df_LGE,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var4, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model4$model_stats
results.model4$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)
```

## Figures
### Fig8-Schoenfelds_residuals
```{r Fig8-Schoenfelds_residuals}
df_selected <- df_LGE %>% 
  mutate(
    CMR_LVEF_5 = CMR_LVEF/5
  ) %>%
  select( 
    outcome_FU_time_death, outcome_death, 
    CMR_LGE_ischemic_extent_count,
    CMR_LGE_ischemic_transmurality,
    CMR_LGE_ischemic_location_4,
    CMR_LGE_midwall_presence,
    demo_age, demo_gender , demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF , history_AFib , med_CKD , history_med_MI , CMR_LVEF_5
  ) %>% droplevels()

model_3 <- coxph(formula =  Surv(outcome_FU_time_death, outcome_death) ~ ., 
                 data = df_selected) 

cox.zph(model_3)

tbl_regression(model_3, exponentiate = TRUE, conf.level = 0.995, pvalue_fun = function(x) style_pvalue(x, digits = 3), label = list()) %>% bold_p() %>% 
  as_gt() %>% gt::tab_header(gt::md("Modèle 3 - risk litterature + LGE extent + granularity without multi"))

c <- cox.zph(fit = model_3, transform ="km") 

# Extract the ggcoxzph plots
plots <- ggcoxzph(c)[1:5] # Assuming you have 5 groups to plot

plots

# Loop through the plots and save them
for (i in seq_along(plots)) {
  # Set up the filename with the current date and letter identifiers
  file_name <- paste0("Fig8-", LETTERS[i], "-Schoenfelds_residuals",Sys.Date(),".png")
  full_path <- here(figures_output_dir, file_name)
  
  # Save each plot
  ggsave(
    filename = full_path,
    plot = plots[[i]],
    width = 10,
    height = 6,
    units = "in",
    dpi = 300
  )
}
```
### Fig9-LGE-KM-LGE_extent
```{r Fig9-LGE-KM-LGE_extent}

# Data parameters
results <- createSurvivalPlot(
  data = df_LGE,
  compared_with = "CMR_LGE_ischemic_extent_categ",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors = c("#4292C6","#FF002B","#2C3E50"),
  my_legends = c("1-2 segments of ischemic LGE", "3-5 ischemic segments", "≥ 6 segments of ischemic"),
  confint_choosen = 0.995,
  mytitle = "Fig9-LGE-KM-LGE_extent"
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig9-LGE-KM-LGE_extent_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig9-LGE-KM-LGE_extent_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```
### Fig10-LGE-KM-LGE_transm
```{r Fig10-LGE-KM-LGE_transm}
# Data parameters
results <- createSurvivalPlot(
  data = df_LGE,
  compared_with = "CMR_LGE_ischemic_transmurality",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors = c("#4292C6","#FF002B","#2C3E50"),
  my_legends = c("Subendocardic <50%", "Subendocardic ≥ 50%", "Transmural"),
  confint_choosen = 0.995,
  mytitle = c("Fig10-LGE-KM-LGE_transm_risk")
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig10-LGE-KM-LGE_transm_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig10-LGE-KM-LGE_transm_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)


```
### KM LGE location
#### Fig11A-LGE-KM-LGE_loca6
```{r Fig11A-LGE-KM-LGE_loca6}
# Data parameters
results <- createSurvivalPlot(
  data = df_LGE,
  compared_with = "CMR_LGE_ischemic_location_6",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors = c("#006400", "darkblue", "darkviolet", "#FF0000", "#8B4513", "#000000"),
  my_legends = c("A_apical", "B_Inferior", "C_Lateral", "D_Anterior", "E_Septal", "Several_localization"),
  confint_choosen = 0.995,
  mytitle = c("Fig11A-LGE-KM-LGE_loca6"),
  show.CI = FALSE
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig11A-LGE-KM-LGE_loca6_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig11A-LGE-KM-LGE_loca6_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```
#### Fig11B-LGE-KM-LGE_loca4
```{r Fig11B-LGE-KM-LGE_loca4}
# Data parameters
results <- createSurvivalPlot(
  data = df_LGE,
  compared_with = "CMR_LGE_ischemic_location_4",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors =  c("#4292C6","#FF002B","#2C3E50"),
  my_legends = c("Other location", "Anterior", "Septal"),
  confint_choosen = 0.995,
  mytitle = c("Fig11B-LGE-KM-LGE_loca4")
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig11B-LGE-KM-LGE_loca4_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig11B-LGE-KM-LGE_loca4_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)

```
### Fig12-LGE-KM-LGE_midwall
```{r Fig12-LGE-KM-LGE_midwall}
# Data parameters
results <- createSurvivalPlot(
  data = df_LGE,
  compared_with = "CMR_LGE_midwall_presence",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors =  c("#FF002B","#2C3E50"),
  my_legends = c("Ischemic LGE (excl)", "Isch and midwall LGE"),
  confint_choosen = 0.995,
  mytitle = c("Fig12-LGE-KM-LGE_midwall")
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig12-LGE-KM-LGE_midwall_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig12-LGE-KM-LGE_midwall_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```
### Fig13-LGE-Stacked_Corr_var 
```{r Fig13-LGE-Stacked_Corr_var}
library(ggplot2)
library(dplyr)
library(here)

# Function to create and save a ggplot
create_and_save_plot <- function(df, filename, title) {
  gg <- ggplot(df, aes(x = IschemicExtent, y = Count, fill = Pattern)) +
    geom_bar(stat = "identity", position = "fill") +
    scale_y_continuous(labels = scales::percent_format()) +
    scale_fill_manual(values = c("#009392","#f8766d","#7f7f7f")) +
    labs(title = title, x = "Ischemic Extent", y = "Percentage", fill = "Pattern") +
    theme_classic() +
    theme(legend.position = "none")
  
  print(gg)
  
  ggsave(filename = here(figures_output_dir, filename), plot = gg, width = 5, height = 6, units = "in", dpi = 600)
}

# Droplevels to clean up factors in df_LGE
df_LGE <- df_LGE %>% droplevels()

# Function to prepare data
prepare_data <- function(category) {
  table_data <- table(df_LGE$CMR_LGE_ischemic_extent_categ, category)
  df <- as.data.frame(table_data)
  names(df) <- c("IschemicExtent", "Pattern", "Count")
  # Reverse the order of 'Pattern' factor levels
  df$Pattern <- factor(df$Pattern, levels = rev(levels(df$Pattern)))
  # Datafra
  df <- df %>%
    group_by(IschemicExtent) %>%
    mutate(Percent = Count / sum(Count) * 100)
  print(df)
  return(df)
}

### By transmurality 
df_transmurality <- prepare_data(df_LGE$CMR_LGE_ischemic_transmurality)
create_and_save_plot(df_transmurality, "Fig13A-LGE-Stacked_Corr_LGE_transmurality.png", "Percentage Stacked Histogram of LGE Characteristics by Ischemic Extent - Transmurality")

### By location 
df_location <- prepare_data(df_LGE$CMR_LGE_ischemic_location_4)
create_and_save_plot(df_location, "Fig13B-LGE-Stacked_Corr_LGE_location.png", "Percentage Stacked Histogram of LGE Characteristics by Ischemic Extent - Location")

### By midwall 
df_midwall <- prepare_data(df_LGE$CMR_LGE_midwall_presence)
create_and_save_plot(df_midwall, "Fig13C-LGE-Stacked_Corr_LGE_midwall.png", "Percentage Stacked Histogram of LGE Characteristics by Ischemic Extent - Midwall")

```
# LGE population with LGE ≤6 segments (N=3,440)
## Survival
### Tab12-univ-minus_LGE-death
```{r Tab12-univ-minus_LGE-death}
df_selected <- df_LGE %>%
  mutate(
    surv.event = Surv(
      time = outcome_FU_time_death,
      event = outcome_death
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  ) %>% filter(
    CMR_LGE_ischemic_extent_count <= 6
  )

Descr_table = createTable(compareGroups(
  surv.event ~ 
    demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
    CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
    
    history_med_MI  + history_coronary_procedure + history_interv_PCI + 
    history_interv_CABG + med_periph_atheroma + history_stroke + 
    med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
    clini_cardiac_rythm + 
    
   outcome_revascularisation_90days +
    
    CMR_LVEF_5 + CMR_LVEDV_5 + 
    CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
    
    CMR_LGE_presence_ischemic_and_midwall +
    
    CMR_LGE_ischemic_presence + 
    CMR_LGE_ischemic_extent_count +
    CMR_LGE_ischemic_extent_categ +
    CMR_LGE_ischemic_transmurality +
    CMR_LGE_ischemic_location_4 +
    
    CMR_LGE_ischemic_anterior + 
    CMR_LGE_ischemic_septal +
    CMR_LGE_ischemic_inferior +
    CMR_LGE_ischemic_lateral +
    CMR_LGE_ischemic_Apical +
    
    CMR_LGE_midwall_presence +
    CMR_LGE_midwall_extent_count + 
    CMR_LGE_midwall_extent_categ +
    CMR_LGE_midwall_location_3 + 
    CMR_LGE_midwall_location_4 +
    CMR_LGE_midwall_anterior +
    CMR_LGE_midwall_septal +
    CMR_LGE_midwall_inferior +
    CMR_LGE_midwall_lateral +
    CMR_LGE_midwall_apical,
  data= df_selected,
  method = 1, conf.level = 0.995),
  hide.no = "No",
  show.ratio=T, show.p.ratio = T) 

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab12-univ-minus_LGE-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)

```
### Tab13-multi_tradi-minus_LGE-death
```{r Tab13-multi_tradi-minus_LGE-death}
df <- df_LGE %>% filter(
    CMR_LGE_ischemic_extent_count <= 6
  ) %>% mutate(
  event = outcome_death,
  time = outcome_FU_time_death,
  CMR_LVEF_5 = CMR_LVEF/5
) %>% select(
  event, time,
  demo_age, demo_gender, demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF, history_AFib, med_CKD, history_med_MI , CMR_LVEF_5, CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_transmurality, CMR_LGE_ischemic_location_4, CMR_LGE_midwall_presence, outcome_revascularisation_90days) %>% droplevels()

#### TABLE 

## Model 1
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LVEF_5))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 1", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","minus_LGE_pop_model1_trad.csv"), append = FALSE)

## Model 2
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 2", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3A
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_transmurality))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3A", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3B
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_location_4))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3B", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))
## Model 3C
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3C", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 4
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))
write.csv(data, file = here("outputs", "csv_files","minus_LGE_pop_model4_trad.csv"), append = FALSE)

## Model 5
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: outcome_revascularisation_90days))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


## MODELS MULTI NESTED
var_base = c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5")

### Nested 4
table <- uni_multi_function(
  df = df, 
  event = "event",
  time = "time", 
  var_base = var_base, 
  var_added = c("CMR_LGE_ischemic_extent_count", "CMR_LGE_ischemic_transmurality","CMR_LGE_ischemic_location_4",
                "CMR_LGE_midwall_presence", "outcome_revascularisation_90days"))

# export in html
knitr::kable(table, caption = "Model full - granularity until revasc (minus LGE pop = 3,440)", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Export in word
ft <- flextable(table)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Model 4 - LGE pop (N=3,440", style = "heading 1") %>%
  body_add_flextable(ft)
print(doc, target = here(tables_output_dir,paste0("Tab13-multi_tradi-minus_LGE-death-",Sys.Date(), ".docx")))
```
### Tab14-incr-minus_LGE-death
```{r Tab14-incr-minus_LGE-death}
var1 <- c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5")
var2 <- c(var1, "CMR_LGE_ischemic_extent_count")
var3A <- c(var2, "CMR_LGE_ischemic_transmurality")
var3B <- c(var2, "CMR_LGE_ischemic_location_4")
var3C <-  c(var2, "CMR_LGE_midwall_presence")
var4 <- c(var2, "CMR_LGE_ischemic_transmurality", "CMR_LGE_ischemic_location_4", "CMR_LGE_midwall_presence")

df_LGE_minus <- df_LGE %>% filter(CMR_LGE_ischemic_extent_count <= 6) %>% mutate(
  time = outcome_FU_time_death,
  event = outcome_death,
  CMR_LVEF = CMR_LVEF/5
)%>% droplevels()

# MODEL 1
results.model1 <- CoxPredictScore(derivation = df_LGE_minus, validation = df_LGE_minus,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var1, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model1$model_stats
results.model1$derivation$auc

# MODEL 2
results.model2 <- CoxPredictScore(derivation = df_LGE_minus, validation = df_LGE_minus,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var2, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model2$model_stats
results.model2$derivation$auc

roc.test(results.model1$roc_derivation$roc_obj, results.model2$roc_derivation$roc_obj)

# MODEL 3A
results.model3A <- CoxPredictScore(derivation = df_LGE_minus, validation = df_LGE_minus,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3A, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3A$model_stats
results.model3A$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3A$roc_derivation$roc_obj)

# MODEL 3B
results.model3B <- CoxPredictScore(derivation = df_LGE_minus, validation = df_LGE_minus,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3B, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3B$model_stats
results.model3B$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3B$roc_derivation$roc_obj)

# MODEL 3C
results.model3C <- CoxPredictScore(derivation = df_LGE_minus, validation = df_LGE_minus,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3C, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3C$model_stats
results.model3C$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3C$roc_derivation$roc_obj)

# MODEL 4
results.model4 <- CoxPredictScore(derivation = df_LGE_minus, validation = df_LGE_minus,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var4, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model4$model_stats
results.model4$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)
```

# MACE population (N=1,500)
## Descriptive
### Tab15-descr-MACEpop-death
```{r Tab15-descr-MACEpop-death}
df_selected <- df_MACE %>%
  mutate(
    outcome_death = as.factor(outcome_death),
    outcome_MACE = as.factor(outcome_MACE),
    outcome_MACE_CV_death = as.factor(outcome_MACE_CV_death),
    outcome_MACE_NonFatal_MI = as.factor(outcome_MACE_NonFatal_MI),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  ) 

Descr_table = createTable(compareGroups(
      outcome_death ~ 
        outcome_death + outcome_MACE + outcome_MACE_CV_death + outcome_MACE_NonFatal_MI +
        demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
        CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
        
        history_med_MI  + history_coronary_procedure + history_interv_PCI + 
        history_interv_CABG + med_periph_atheroma + history_stroke + 
        med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
        clini_cardiac_rythm + 
        
        CMR_LVEF_5 + CMR_LVEDV_5 + 
        CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
        
        CMR_LGE_ischemic_presence + 
        CMR_LGE_ischemic_extent_count +
        CMR_LGE_ischemic_extent_categ + 
        CMR_LGE_ischemic_transmurality +
        CMR_LGE_ischemic_location_4 +
        
        CMR_LGE_ischemic_anterior + 
        CMR_LGE_ischemic_septal +
        CMR_LGE_ischemic_inferior +
        CMR_LGE_ischemic_lateral +
        CMR_LGE_ischemic_Apical +
        
        CMR_LGE_midwall_presence +
      
        CMR_LGE_presence_ischemic_and_midwall +
        
        outcome_revascularisation_90days,
  data= df_selected,
  method = 1, conf.level = 0.995), # Pvalue
  hide.no = "No", show.all = TRUE, show.p.overall = TRUE) # bug avec le hide

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab15-descr-MACEpop-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab16-descr-MACEpop-MACE
```{r Tab16-descr-MACEpop-MACE}
df_selected <- df_MACE %>%
  mutate(
    outcome_death = as.factor(outcome_death),
    outcome_MACE = as.factor(outcome_MACE),
    outcome_MACE_CV_death = as.factor(outcome_MACE_CV_death),
    outcome_MACE_NonFatal_MI = as.factor(outcome_MACE_NonFatal_MI),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  ) 

Descr_table = createTable(compareGroups(
      outcome_MACE ~ 
        outcome_death + outcome_MACE + outcome_MACE_CV_death + outcome_MACE_NonFatal_MI +
        demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
        CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
        
        history_med_MI  + history_coronary_procedure + history_interv_PCI + 
        history_interv_CABG + med_periph_atheroma + history_stroke + 
        med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
        clini_cardiac_rythm + 
        
        CMR_LVEF_5 + CMR_LVEDV_5 + 
        CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
        
        CMR_LGE_ischemic_presence + 
        CMR_LGE_ischemic_extent_count +
        CMR_LGE_ischemic_extent_categ + 
        CMR_LGE_ischemic_transmurality +
        CMR_LGE_ischemic_location_4 +
        
        CMR_LGE_ischemic_anterior + 
        CMR_LGE_ischemic_septal +
        CMR_LGE_ischemic_inferior +
        CMR_LGE_ischemic_lateral +
        CMR_LGE_ischemic_Apical +
        
        CMR_LGE_midwall_presence +
      
        CMR_LGE_presence_ischemic_and_midwall +
        
        outcome_revascularisation_90days,
  data= df_selected,
  method = 1, conf.level = 0.995), # Pvalue
  hide.no = "No", show.all = TRUE, show.p.overall = TRUE) # bug avec le hide

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab16-descr-MACEpop-MACE-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
## Survival
### Tab17-univ-MACEpop-death
```{r Tab17-univ-MACEpop-death}
df_selected <- df_MACE %>%
  mutate(
    surv.event = Surv(
      time = outcome_FU_time_death,
      event = outcome_death
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  )

Descr_table = createTable(compareGroups(
      surv.event ~ 
        demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
        CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
        
        history_med_MI  + history_coronary_procedure + history_interv_PCI + 
        history_interv_CABG + med_periph_atheroma + history_stroke + 
        med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
        clini_cardiac_rythm + 
        
        CMR_LVEF_5 + CMR_LVEDV_5 + 
        CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
        
        CMR_LGE_ischemic_presence + 
        CMR_LGE_ischemic_extent_count +
        CMR_LGE_ischemic_extent_categ + 
        CMR_LGE_ischemic_transmurality +
        CMR_LGE_ischemic_location_4 +
        
        CMR_LGE_ischemic_anterior + 
        CMR_LGE_ischemic_septal +
        CMR_LGE_ischemic_inferior +
        CMR_LGE_ischemic_lateral +
        CMR_LGE_ischemic_Apical +
        
        CMR_LGE_midwall_presence +
      
        CMR_LGE_presence_ischemic_and_midwall +
        
        outcome_revascularisation_90days,
  data= df_selected,
  method = 1, conf.level = 0.995), # Pvalue
  hide.no = "No", show.p.ratio = T, show.ratio = TRUE) # bug avec le hide

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab17-univ-MACEpop-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab18-univ-MACEpop-MACE
```{r Tab18-univ-MACEpop-MACE}
df_selected <- df_MACE %>%
  mutate(
    surv.event = Surv(
      time = time.censored,
      event = outcome_MACE
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  )

Descr_table = createTable(compareGroups(
      surv.event ~ 
        demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
        CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
        
        history_med_MI  + history_coronary_procedure + history_interv_PCI + 
        history_interv_CABG + med_periph_atheroma + history_stroke + 
        med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
        clini_cardiac_rythm + 
        
        CMR_LVEF_5 + CMR_LVEDV_5 + 
        CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
        
        CMR_LGE_ischemic_presence + 
        CMR_LGE_ischemic_extent_count +
        CMR_LGE_ischemic_extent_categ + 
        CMR_LGE_ischemic_transmurality +
        CMR_LGE_ischemic_location_4 +
        
        CMR_LGE_ischemic_anterior + 
        CMR_LGE_ischemic_septal +
        CMR_LGE_ischemic_inferior +
        CMR_LGE_ischemic_lateral +
        CMR_LGE_ischemic_Apical +
        
        CMR_LGE_midwall_presence +
      
        CMR_LGE_presence_ischemic_and_midwall +
        
        outcome_revascularisation_90days,
  data= df_selected,
  method = 1, conf.level = 0.995), # Pvalue
  hide.no = "No", show.p.ratio = T, show.ratio = TRUE) # bug avec le hide

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab18-univ-MACEpop-MACE-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab19-multi_tradi-MACEpop-MACE
```{r Tab19-multi_tradi-MACEpop-MACE}
df <- df_MACE %>% mutate(
  event = outcome_MACE,
  time = time.censored
) %>% select(
  event, time,
  demo_age, demo_gender, demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF, history_AFib, med_CKD, history_med_MI , CMR_LVEF, CMR_LGE_ischemic_presence) %>% droplevels()

#### TABLE 

## Model 1
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LVEF))

tbl_regression(model, exponentiate = FALSE, conf.level = 0.995,  pvalue_fun = function(x) style_pvalue(x, digits = 3), label = list()) %>% bold_p() %>% 
  as_gt() %>% gt::tab_header(gt::md("score coef - model 1"))

## Model 2
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_presence))

tbl_regression(model, exponentiate = FALSE, conf.level = 0.995,  pvalue_fun = function(x) style_pvalue(x, digits = 3), label = list()) %>% bold_p() %>% 
  as_gt() %>% gt::tab_header(gt::md("score coef - model 2"))

# Table uni multi 
table <- uni_multi_function(
  df = df, 
  event = "event",
  time = "time", 
  var_base = c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF"), 
  var_added = c("CMR_LGE_ischemic_presence"))

# export in html
knitr::kable(table, caption = "Model X - LGE presence - MACE population (N=1,500)", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Export in word
ft <- flextable(table)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Model X - LGE presence in all pop (N=6,082)", style = "heading 1") %>%
  body_add_flextable(ft)

print(doc, target = here(tables_output_dir,paste0("Tab19-multi_tradi-MACEpop-MACE-",Sys.Date(), ".docx")))
```

# MACE population + LGE (N=797)
## Survival
### Tab20-univ-MACE_LGEpop-death
```{r Tab20-univ-MACE_LGEpop-death}
df_selected <- df_MACE %>%
   filter(CMR_LGE_ischemic_presence == "Presence_of_ischemic_LGE") %>%
  mutate(
    surv.event = Surv(
      time = outcome_FU_time_death,
      event = outcome_death
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  )

Descr_table = createTable(compareGroups(
      surv.event ~ 
        demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
        CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
        
        history_med_MI  + history_coronary_procedure + history_interv_PCI + 
        history_interv_CABG + med_periph_atheroma + history_stroke + 
        med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
        clini_cardiac_rythm + 
        
        CMR_LVEF_5 + CMR_LVEDV_5 + 
        CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
        
        CMR_LGE_ischemic_presence + 
        CMR_LGE_ischemic_extent_count +
        CMR_LGE_ischemic_extent_categ + 
        CMR_LGE_ischemic_transmurality +
        CMR_LGE_ischemic_location_4 +
        
        CMR_LGE_ischemic_anterior + 
        CMR_LGE_ischemic_septal +
        CMR_LGE_ischemic_inferior +
        CMR_LGE_ischemic_lateral +
        CMR_LGE_ischemic_Apical +
        
        CMR_LGE_midwall_presence +
      
        CMR_LGE_presence_ischemic_and_midwall +
        
        outcome_revascularisation_90days,
  data= df_selected,
  method = 1, conf.level = 0.995), # Pvalue
  hide.no = "No", show.p.ratio = T, show.ratio = TRUE) # bug avec le hide

export2md(Descr_table, strip=TRUE, first.strip=TRUE)

export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab20-univ-MACE_LGEpop-death-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab21-univ-MACE_LGEpop-MACE
```{r Tab21-univ-MACE_LGEpop-MACE}
df_selected <- df_MACE %>%
  filter(CMR_LGE_ischemic_presence == "Presence_of_ischemic_LGE") %>%
  mutate(
    surv.event = Surv(
      time = time.censored,
      event = outcome_MACE
    ),
    CMR_LVEF_5 = CMR_LVEF/5,
    CMR_LVEDV_5 = CMR_LVEDV/10,
    CMR_LVESV_5 = CMR_LVESV/10
  )

coxph(surv.event ~ med_pacemaker, data = df_selected)

Descr_table = createTable(compareGroups(
      surv.event ~ 
        demo_age + demo_gender + demo_BMI + CV_risk_diabete + 
        CV_risk_HTA + CV_risk_obesity + CV_risk_dyslipidemia + CV_risk_Smoking + 
        
        history_med_MI  + history_coronary_procedure + history_interv_PCI + 
        history_interv_CABG + med_periph_atheroma + history_stroke + 
        med_pacemaker + med_CKD + history_hospit_HF + history_AFib + clini_NYHA + 
        clini_cardiac_rythm + 
        
        CMR_LVEF_5 + CMR_LVEDV_5 + 
        CMR_LVESV_5 + CMR_LV_mass + CMR_RV_dysfunction + 
        
        CMR_LGE_ischemic_presence + 
        CMR_LGE_ischemic_extent_count +
        CMR_LGE_ischemic_extent_categ + 
        CMR_LGE_ischemic_transmurality +
        CMR_LGE_ischemic_location_4 +
        
        CMR_LGE_ischemic_anterior + 
        CMR_LGE_ischemic_septal +
        CMR_LGE_ischemic_inferior +
        CMR_LGE_ischemic_lateral +
        CMR_LGE_ischemic_Apical +
        
        CMR_LGE_midwall_presence +
      
        CMR_LGE_presence_ischemic_and_midwall +
        
        outcome_revascularisation_90days,
  data= df_selected,
  method = 1, conf.level = 0.995), # Pvalue
  hide.no = "No", show.p.ratio = T, show.ratio = TRUE) # bug avec le hide

export2md(Descr_table, strip=TRUE, first.strip=TRUE)





export2word(x = Descr_table, 
            file = here(tables_output_dir, paste0("Tab21-univ-MACE_LGEpop-MACE-",Sys.Date(), ".docx")), 
            which.table="descr", nmax=TRUE, header.labels=c(), 
            caption=NULL, strip=FALSE, first.strip=FALSE, background="#D2D2D2",
            size=NULL, header.background=NULL, header.color=NULL)
```
### Tab22-multi_tradi-MACE_LGEpop-MACE
```{r Tab22-multi_tradi-MACE_LGEpop-MACE}
df <- df_MACE %>% filter(CMR_LGE_ischemic_presence == "Presence_of_ischemic_LGE") %>%
  mutate(
  event = outcome_MACE,
  time = time.censored,
  CMR_LVEF_5 = CMR_LVEF/5,
  CMR_LGE_ischemic_transmurality_bin = case_when(
    CMR_LGE_ischemic_transmurality == "B_Subendocardial<50%" ~ "A_viable",
    CMR_LGE_ischemic_transmurality != "B_Subendocardial<50%" ~ "B_non_viable",
    TRUE ~ NA
  )
) %>% select(
  event, time,
  demo_age, demo_gender, demo_BMI , CV_risk_diabete , CV_risk_Smoking , CV_risk_dyslipidemia ,  history_hospit_HF, history_AFib, med_CKD, history_med_MI , CMR_LVEF_5, CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_transmurality_bin, CMR_LGE_ischemic_location_4, CMR_LGE_midwall_presence, outcome_revascularisation_90days) %>% droplevels()

#### TABLE 

## Model 1
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LVEF_5))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 1", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

write.csv(data, file = here("outputs", "csv_files","MACE_pop_model1_trad.csv"), append = FALSE)

## Model 2
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 2", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3A
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_transmurality_bin))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3A", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 3B
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_ischemic_location_4))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3B", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))
## Model 3C
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event:CMR_LGE_ischemic_extent_count, CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 3C", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

## Model 4
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: CMR_LGE_midwall_presence))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))
write.csv(data, file = here("outputs", "csv_files","MACE_pop_model4_trad.csv"), append = FALSE)

## Model 5
model <- coxph(formula =  Surv(time, event) ~ ., data = df %>% select(event: outcome_revascularisation_90days))
data <- extract_model_stats(model, conf_level = 0.995)
knitr::kable(data, caption = "Model 4", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))


## MODELS MULTI NESTED
var_base = c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5")

### Nested 4
table <- uni_multi_function(
  df = df, 
  event = "event",
  time = "time", 
  var_base = var_base, 
  var_added = c("CMR_LGE_ischemic_extent_count", "CMR_LGE_ischemic_transmurality_bin","CMR_LGE_ischemic_location_4",
                "CMR_LGE_midwall_presence", "outcome_revascularisation_90days"))

# export in html
knitr::kable(table, caption = "Model full - MACE granularity (MACE = 797)", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Export in word
ft <- flextable(table)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Model 4 - MACE with LGE pop (794)", style = "heading 1") %>%
  body_add_flextable(ft)
print(doc, target = here(tables_output_dir,paste0("Tab22-multi_tradi-MACE_LGEpop-MACE-",Sys.Date(), ".docx")))
```


### Tab23-incr-MACE_LGEpop-MACE
```{r Tab23-incr-MACE_LGEpop-MACE}
var1 <- c("demo_age", "demo_gender" , "demo_BMI" , "CV_risk_diabete" , "CV_risk_Smoking" , "CV_risk_dyslipidemia" ,  "history_hospit_HF", "history_AFib" , "med_CKD" , "history_med_MI" , "CMR_LVEF_5")
var2 <- c(var1, "CMR_LGE_ischemic_extent_count")
var3A <- c(var2, "CMR_LGE_ischemic_transmurality_bin")
var3B <- c(var2, "CMR_LGE_ischemic_location_4")
var3C <-  c(var2, "CMR_LGE_midwall_presence")
var4 <- c(var2, "CMR_LGE_ischemic_transmurality_bin", "CMR_LGE_ischemic_location_4", "CMR_LGE_midwall_presence")

df_selected <- df_MACE %>% filter(
  CMR_LGE_ischemic_presence=="Presence_of_ischemic_LGE") %>% mutate(
  time = time.censored,
  event = outcome_MACE,
  CMR_LVEF_5 = CMR_LVEF/5,
  CMR_LGE_ischemic_transmurality_bin = case_when(
    CMR_LGE_ischemic_transmurality == "B_Subendocardial<50%" ~ "A_viable",
    CMR_LGE_ischemic_transmurality != "B_Subendocardial<50%" ~ "B_non_viable",
    TRUE ~ NA)
) %>% droplevels()


# MODEL 1
results.model1 <- CoxPredictScore(derivation = df_selected, validation = df_selected,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var1, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model1$model_stats
results.model1$derivation$auc

# MODEL 2
results.model2 <- CoxPredictScore(derivation = df_selected, validation = df_selected,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var2, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model2$model_stats
results.model2$derivation$auc

roc.test(results.model1$roc_derivation$roc_obj, results.model2$roc_derivation$roc_obj)

# MODEL 3A
results.model3A <- CoxPredictScore(derivation = df_selected, validation = df_selected,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3A, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3A$model_stats
results.model3A$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3A$roc_derivation$roc_obj)

# MODEL 3B
results.model3B <- CoxPredictScore(derivation = df_selected, validation = df_selected,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3B, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3B$model_stats
results.model3B$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3B$roc_derivation$roc_obj)

# MODEL 3C
results.model3C <- CoxPredictScore(derivation = df_selected, validation = df_selected,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var3C, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model3C$model_stats
results.model3C$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model3C$roc_derivation$roc_obj)

# MODEL 4
results.model4 <- CoxPredictScore(derivation = df_selected, validation = df_selected,
                       time.name = "time", 
                       times = 10*12,
                       event.name ="event", 
                       variables = var4, 
                       n_bootstrap = 100, 
                       ci_level = 0.995, 
                       seed = 123)

results.model4$model_stats
results.model4$derivation$auc

roc.test(results.model2$roc_derivation$roc_obj, results.model4$roc_derivation$roc_obj)
```

# Score using all LGE population
## Tab24-score_development
```{r Tab24-score_development}
# 1) Coxph function
df <- df_LGE %>% droplevels()

# Function

# Assuming model is already correctly fitted as shown:
model <- coxph(formula =  Surv(outcome_FU_time_death, outcome_death) ~ CMR_LGE_ischemic_extent_count + CMR_LGE_ischemic_transmurality + CMR_LGE_ischemic_location_4 + CMR_LGE_midwall_presence, data = df)



# Function
data <- extract_model_stats(model, conf_level = 0.995, decimals = 2)

# Additional transformations as per your code (multiplying coefficients by 3, etc.)
data <- data %>%
  mutate(
    # Extract the coefficient and convert to numeric using gsub to remove non-numeric parts
    coefficients = as.numeric(gsub(" .*", "", Coefficients_CI)),
    # Multiply the extracted coefficient by 3
    coeff_x3 = coefficients * 3,
    # Round the result of the multiplication
    score = round(coeff_x3)
  )


knitr::kable(data, caption = "Score", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Create a new Word document
write.csv(x = data, file = here(tables_output_dir,"Tab24-score_development.csv"), col.names = TRUE)


# 3) Find best cut-off
fit = partykit::ctree(Surv(outcome_FU_time_death/12, outcome_death) ~ score, data = df, maxdepth = 2)

plot(fit,
     main = "Decision tree for score on derivation (N=2,900)",
     digits = 2, cex = 0.2, branch.type = "square",
     tp_args = list(pval = TRUE), 
     gp_args = list(fontsize = 2))
```
## Fig14-Schoenfelds_residuals_score
```{r Fig14-Schoenfelds_residuals_score}
fit <- coxph(formula =  Surv(outcome_FU_time_death, outcome_death) ~ score, data = df_LGE)

model <- cox.zph(fit)

plot <- ggcoxzph(model)[1]
plot

    # Save each plot
ggsave(
    filename = here(figures_output_dir, paste0("Fig14-Schoenfelds_residuals_score-",Sys.Date(),".png")),
    plot = plot[[1]],
    width = 10,
    height = 6,
    units = "in",
    dpi = 300
  )
```
## Mortality
### Fig15-Score_mortality_spline WILSON
```{r Fig15-Score_mortality_spline}
library(binom)

# Assuming df_LGE is your dataframe
data <- df_LGE %>%
  droplevels() %>%
  mutate(
    event = outcome_death,
    time = outcome_FU_time_death
  )

# Summarizing data and calculating Wilson score intervals
D <- data %>%
  group_by(score) %>%
  summarise(
    n = n(),
    events_sum = sum(event),  # Sum of events per group
    mortality = events_sum / n,  # Proportion of events
    survival = 1 - mortality,
    std_error = sd(event, na.rm = TRUE) / sqrt(n),  # Standard error of event proportion
    col = unique(score_categ)
  ) %>%
  mutate(
    wilson = binom.confint(events_sum, n, methods = "wilson", conf.level = 0.995)  # Calculating Wilson score intervals
  )

# Extracting lower and upper bounds from Wilson score
D <- D %>%
  mutate(
    lower_95 = wilson[, "lower"],
    upper_95 = wilson[, "upper"]
  )

# For the graphics
D[16:17, "upper_95"] <- 1.01

# Continue with your existing plotting code
color_palette <- c("1_low_risk" = "green4", "2_medium_risk" = "orange2", "3_high_risk" = "red4")
max_n <- max(D$n)
scale_factor <- max_n / max(D$mortality, na.rm = TRUE)

# Smooth predictions and confidence intervals using loess model
D$smooth_pred <- predict(loess(mortality * max_n ~ score, data = D), se = FALSE)
D$smooth_lower <- predict(loess(lower_95 * max_n ~ score, data = D), se = FALSE)
D$smooth_upper <- predict(loess(upper_95 * max_n ~ score, data = D), se = FALSE)

# Base plot with mortality predictions
gggraph <- ggplot(D, aes(x = score, y = mortality * max_n)) +
  geom_bar(stat = "identity", aes(y = n, fill = col), position = position_dodge(), width = 0.9) +
  scale_fill_manual(values = color_palette) +
  geom_ribbon(aes(ymin = smooth_lower, ymax = smooth_upper), fill = "#F37B59", alpha = 1) +
  geom_line(aes(y = smooth_pred), color = "red", size = 1.5) +
  scale_y_continuous(
    name = "Frequency (N)",
    sec.axis = sec_axis(~ . / max(D$n), name = "All-cause mortality rate (%)"),
    limits = c(-0.1 * max_n, 1.3 * max_n)
  ) +
  labs(
    title = "The CMR-LGE score (N=3,591)",
    x = "CMR-LGE score",
    y = "Frequency (N)"
  ) +
  xlim(0, max(D$score)) +
  scale_x_continuous(breaks = 1:17) +
  theme_classic(base_size = 14) +
  theme(
    plot.background = element_rect(fill = "white", color = NA),
    panel.background = element_rect(fill = "white", color = NA),
    legend.position = "none",
    axis.line = element_line(color = "black"),
    axis.text = element_text(color = "black"),
    axis.title = element_text(color = "black")
  )

# Print the plot
print(gggraph)

# Save the plot in a folder
ggsave(
  filename = here(figures_output_dir, paste0("Fig15-Score_mortality_spline", Sys.Date(),".png")),
  plot = gggraph, width = 9, height = 6, units = "in", dpi = 600)

```
### Tab25-Mortality prediction at 5 and 10 years (w/bootstrap)
```{r Tab25-Mortality prediction at 5 and 10 years}
library(survival)
library(dplyr)
library(purrr)  # for the map functions
library(kableExtra)

# Main analysis
n_bootstrap <- 100
time.choosen <- 10*12  # Predicting at 5 and 10 years

# Assuming df_LGE is your dataframe
data <- df_LGE %>%
  droplevels() %>%
  mutate(
    event = outcome_death,
    time = outcome_FU_time_death
  )

# Function to process data for survival analysis
process_data <- function(data, event_name, time_name, time_threshold) {
  data$event_time <- ifelse(data[[event_name]] == 1 & data[[time_name]] < time_threshold, 1,
                            ifelse(data[[time_name]] >= time_threshold, 0, NA))
  data <- filter(data, !is.na(event_time))
  return(data)
}

# Preprocess the dataset
data_processed <- process_data(data, event_name = "event", time_name = "time", time_threshold = time.choosen)


# Fitting a Cox model
model.cox <- coxph(Surv(time, event_time) ~ score, data = data_processed, x = TRUE)

# Function to generate predictions for bootstrap samples
predictions_function <- function(data, model, times) {
  indices <- sample(1:nrow(data), replace = TRUE)
  bootstrap_sample <- data[indices, ]
  predictions <- 1 - predictSurvProb(model, newdata = bootstrap_sample, times = c(times))
  # Return a dataframe with predictions and the associated scores
  data.frame(score = bootstrap_sample$score, predictions = predictions)
}

# Assuming `data_processed` is your pre-processed dataset and `model.cox` is your fitted Cox model
n_bootstrap <- 100  # Number of bootstrap samples
time.choosen <- 5 * 12  # Predicting at 5 years, can add more times if needed
# Apply bootstrap to calculate predictions for each iteration
bootstrap_results <- purrr::map(1:n_bootstrap, ~predictions_function(data_processed, model.cox, time.choosen))
# Combine all bootstrap results into a single dataframe
bootstrap_data <- do.call(rbind, bootstrap_results)
# Group by score and summarize the predictions in a list or any other summary statistic
summary_data.5 <- bootstrap_data %>%
  group_by(score) %>%
  summarise(
    mean_predictions.5 = mean(predictions, na.rm = TRUE)
  )


# Assuming `data_processed` is your pre-processed dataset and `model.cox` is your fitted Cox model
n_bootstrap <- 100  # Number of bootstrap samples
time.choosen <- 10 * 12  # Predicting at 5 years, can add more times if needed
# Apply bootstrap to calculate predictions for each iteration
bootstrap_results <- purrr::map(1:n_bootstrap, ~predictions_function(data_processed, model.cox, time.choosen))
# Combine all bootstrap results into a single dataframe
bootstrap_data <- do.call(rbind, bootstrap_results)
# Group by score and summarize the predictions in a list or any other summary statistic
summary_data.10 <- bootstrap_data %>%
  group_by(score) %>%
  summarise(
    mean_predictions.10 = mean(predictions, na.rm = TRUE)
  )

summary_data <- cbind(summary_data.5, summary_data.10)
df_data <- summary_data[,c(1,2,4)]
df_data
write.csv(df_data, file = "outputs/csv_files/pred_by_score.csv")


# export in html
knitr::kable(df_data, caption = "Prediction by the score (Tab25)", format = "html") %>%
  kableExtra::kable_styling(full_width = F, bootstrap_options = c("striped", "hover", "condensed", "bordered"))

# Export in word
ft <- flextable(df_data)
ft <- set_table_properties(ft, layout = "autofit")
doc <- read_docx() %>%
  body_add_par("Prediction by the score (Tab25)", style = "heading 1") %>%
  body_add_flextable(ft)

print(doc, target = here(tables_output_dir,paste0("Tab25-Predictions_Score-",Sys.Date(), ".docx")))
```

### Fig16-Score_mortality_stacked
```{r Fig16-Score_mortality_stacked}
data <- df_LGE %>% 
  droplevels() %>% mutate(
        event = outcome_death,
        time = outcome_FU_time_death
      )


# Assuming df contains your data and D contains the summarized results
D <- data %>%
  group_by(score) %>%
  summarise(
    n = n(),
    events_sum = sum(event),  # Sum of events per group
    mortality = events_sum / n,  # Proportion of events
    survival = 1-mortality,
    std_error = sd(event) / sqrt(n),  # Standard error of event proportion
    lower_95 = mortality - 1.96 * std_error,
    upper_95 = mortality + 1.96 * std_error,
    col = unique(score_categ)
  ) 

color_palette <- c("1_low_risk" = "green4", "2_medium_risk" = "orange2", "3_high_risk" = "red4")

# the dataframe
D <- as.data.frame(D)

# Reshape the data for plotting
df_long <- D  %>%
  pivot_longer(cols = c("mortality", "survival"), names_to = "outcome", values_to = "proportion")

# Creating the 100% stacked bar plot
g <- ggplot(df_long, aes(x = factor(score), y = proportion, fill = outcome)) +
  geom_bar(stat = "identity", position = "fill") +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "Score", y = "Proportion of Outcome", fill = "Outcome") +
  theme_classic() +
  scale_fill_manual(values = c("mortality" = "red", "survival" = "green4")) # Customize colors as needed

g

ggsave(
  filename = here(figures_output_dir, paste0("Fig16-Score_mortality_stacked-", Sys.Date(),"_plot.png")),
  plot = g, width = 9, height = 6, units = "in", dpi = 600)
```
### Function for AUC and PRAUC (to add)
### Fig17-Score_AUC10
```{r Fig17-Score_AUC10}
data <- df_LGE %>%
  droplevels()

results.score.10 <- CoxPredictScore(
  derivation = data,
  validation = data,
  time.name = "outcome_FU_time_death",
  times = 10*12,
  event.name ="outcome_death",
  variable = "score",
  n_bootstrap = 100,
  ci_level = 0.995,
  seed = 123)


# CREATING AUC CURVES
roclist <- list(results.score.10$roc_derivation$roc_obj)

names(roclist) <- c(paste0("AUC Score - ", results.score.10$derivation$auc ))

library(pROC)
# GRAPHCIS - AUC (Solenn)
g <- ggroc(roclist, aes = "colour", legacy.axes = TRUE) + geom_line(size = 0.8) +
  theme_classic()+
  ggtitle("AUC 10 years") +
  labs(x = "1 - Specificity",
       y = "Sensitivity") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 14),  # Increase size of X axis labels
    axis.text.y = element_text(size = 14),  # Increase size of Y axis labels
    axis.title.x = element_text(size = 16),  # Increase size of X axis title
    axis.title.y = element_text(size = 16),  # Increase size of Y axis title
    legend.text = element_text(size=14),
    legend.position = c(0.95, 0.05),  # Adjust the position within the graph (x, y)
    legend.justification = c(1, 0),  # Set the justification to bottom-right
    legend.box.just = "right",  # Set the legend box justification to right
    legend.title = element_blank(),  # Remove legend title
    legend.box.background = element_rect(color = "black", fill = NA)) +  # Add black border

  scale_colour_manual(values = c( "red"))


# Add the y = x line (line of equality)
g <- g + geom_abline(intercept = 0, slope = 1, linetype = "dashed", color = "black")

g

ggsave(
  filename = here(figures_output_dir, paste0("Fig17-Score_AUC10-", Sys.Date(),".png")),
  plot = g, width = 9, height = 6, units = "in", dpi = 600)
```
### Fig18-Score_PRAUC10
```{r Fig18-Score_PRAUC10}
data <- df_LGE %>%
  droplevels()

results.score.10 <- CoxPredictScore(
  derivation = data,
  validation = data,
  time.name = "outcome_FU_time_death",
  times = 10*12,
  event.name ="outcome_death",
  variable = "score",
  n_bootstrap = 100,
  ci_level = 0.995,
  seed = 123)

perc_death <- 379/1790


g <- ggplot() +
  geom_line(data = results.score.10$roc_derivation$coords, aes(x = recall, y = precision, color = "A_Score")) +
  geom_hline(yintercept = perc_death, color = "black", linetype = "dashed") +
  labs(
    x = "Recall",
    y = "Precision",
    title = "PRAUC 10",
    color = "Dataset"
  ) +
  scale_color_manual(
    values = c("A_Score" = "red"),
    labels = c(paste("Cox Score - ", results.score.10$derivation$prauc)))+
  theme_classic () +
  theme(
    plot.title = element_text(size = 14, hjust = 0.5),
    plot.subtitle = element_text(size = 12, hjust = 0.5),
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 14),  # Increase size of X axis labels
    axis.text.y = element_text(size = 14),  # Increase size of Y axis labels
    axis.title.x = element_text(size = 16),  # Increase size of X axis title
    axis.title.y = element_text(size = 16),  # Increase size of Y axis title
    legend.text = element_text(size=14),
    legend.position = c(0.9, 0.05),
    legend.justification = c(1, 0),
    legend.box.just = "right",  # Set the legend box justification to right
    legend.title = element_blank(),  # Remove legend title
    legend.box.background = element_rect(color = "black", fill = NA),
    plot.margin = margin(20, 20, 20, 20),
    plot.background = element_rect(fill = "white", color = "white", size = 1)) +  # Add a white background

    scale_y_continuous(limits = c(0, 1))  # Set y-axis limits to 0 and 1

g

ggsave(
  filename = here(figures_output_dir, paste0("Fig18-Score_PRAUC10-", Sys.Date(),".png")),
  plot = g, width = 6, height = 6, units = "in", dpi = 600)
```
### Fig19-LGE-KM-score-death
```{r Fig19-LGE-KM-score-death}
df_selected <- df_LGE %>% mutate(
  event = outcome_death,
  time = outcome_FU_time_death
)

# Data parameters
results <- createSurvivalPlot(
  data = df_LGE,
  compared_with = "score_categ",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors =  c("green4","orange2","red4"),
  my_legends = c("Low","Medium", "High"),
  confint_choosen = 0.995,
  mytitle = c("Fig19-LGE-KM-score-death")
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig19-LGE-KM-score-death_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig19-LGE-KM-score-death_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)
```
### Fig20-LGE-KM-score-MACE
```{r Fig20-LGE-KM-score-MACE}
###### UNIVARIATE
df_selected <- df_MACE %>% mutate(
  event = outcome_MACE,
  time = time.censored # method of censoring when poatients die from another cause. 
)


# Data parameters
results <- createSurvivalPlot(
  data = df_selected,
  compared_with = "score_categ",
  time = "outcome_FU_time_death",
  event = "outcome_death",
  my_colors =  c("green4","orange2","red4"),
  my_legends = c("Low","Medium", "High"),
  confint_choosen = 0.995,
  mytitle = c("Fig20-LGE-KM-score-MACE")
)

results$HR
results$ggsurv

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig20-LGE-KM-score-MACE_plot-", Sys.Date(),".png")),
  plot = results$ggsurv$plot, width = 10, height = 6, units = "in", dpi = 600)
ggsave(
  filename = here(figures_output_dir,paste0("Fig20-LGE-KM-score-MACE_risk-", Sys.Date(),".png")),
  plot = results$ggsurv$table, width = 10, height = 3, units = "in", dpi = 600)

```

# Other figures
## Fig21-Csv_ARP_plot 
exported in csv to build the graphics on excell
```{r Fig21-Csv_ARP_plot}
# 1] extent
py <- pyears(Surv(outcome_FU_time_death*(365/12), outcome_death) ~ CMR_LGE_ischemic_extent_categ, data = df_LGE, data.frame = T)
df_ext<<- py$data
colnames(df_ext)[1] <- "subgroups"
df_ext$group <- "B_Ext"
df_ext$annual_rates <- round(100*(df_ext$event/df_ext$pyears), 1) # Ca fait du 100 personnes années

# 2] TRANSMURALITY
py <- pyears(Surv(outcome_FU_time_death*(365/12), outcome_death) ~ CMR_LGE_ischemic_transmurality, data = df_LGE, data.frame = T)
df_transm<<- py$data
colnames(df_transm)[1] <- "subgroups"
df_transm$group <- "C_Transm"
df_transm$annual_rates <- round(100*(df_transm$event/df_transm$pyears), 1) # Ca fait du 100 personnes années

# 3] MULTIPLE
py <- pyears(Surv(outcome_FU_time_death*(365/12), outcome_death) ~ CMR_LGE_ischemic_multiple, data = df_LGE, data.frame = T)
df_multi<<- py$data
colnames(df_multi)[1] <- "subgroups"
df_multi[1,1] <- "A_Focal"
df_multi[2,1] <- "B_Multi"
df_multi$group <- "D_Multiple"
df_multi$annual_rates <- round(100*(df_multi$event/df_multi$pyears), 1) # Ca fait du 100 personnes années

# 4] SEPTAL
py <- pyears(Surv(outcome_FU_time_death*(365/12), outcome_death) ~ CMR_LGE_ischemic_location_4, data = df_LGE, data.frame = T)
df_septal <- py$data
colnames(df_septal)[1] <- "subgroups"
df_septal[1,1] <- "A_No_septal"
df_septal[2,1] <- "B_Anterior"
df_septal[3,1] <- "C_Septal"
df_septal$group <- "E_localization"
df_septal$annual_rates <- round(100*(df_septal$event/df_septal$pyears), 1) # Ca fait du 100 personnes années

# 5] MIDWALL
py <- pyears(Surv(outcome_FU_time_death*(365/12), outcome_death) ~ CMR_LGE_midwall_presence, data = df_LGE, data.frame = T)
df_mid<<- py$data
colnames(df_mid)[1] <- "subgroups"
df_mid[1,1] <- "A_No_midwall_ass"
df_mid[2,1] <- "B_Midwall_ass"
df_mid$group <- "F_Midwall"
df_mid
df_mid$annual_rates <- round(100*(df_mid$event/df_mid$pyears), 1) # Ca fait du 100 personnes années

# GLOBAL DF
df_global <- rbind(df_ext, df_transm, df_multi, df_septal ,df_mid) #df_normal
df_global <- df_global %>% mutate(subgroups = paste(as.character(group), "~", subgroups,sep=""))


# Create the grouped barplot using ggplot2
library(ggplot2)

# Create the plot
gg_graph <- ggplot(df_global, aes(x = group, y = annual_rates, fill = subgroups, label = annual_rates)) +
  geom_bar(position = "dodge", stat = "identity", just = 1, width = 0.7) +  # Equal-width bars
  scale_fill_manual(values = adjustcolor(c("#4292C6","#D52B2B","#2C3E50","#4292C6","#D52B2B","#2C3E50", "#D52B2B", "#2C3E50","#4292C6","#D52B2B","#2C3E50","#D52B2B","#2C3E50"), alpha.f = 0.8)) +  # Set custom colors
  labs(title = "Grouped Barplot with Subgroups",
       x = "group",  # X-axis label
       y = "Annual Rates",     # Y-axis label
       fill = "subgroups") +   # Legend title
  geom_text(
    aes(x = group, y = annual_rates, label = sprintf("%.1f", annual_rates), group = subgroups),
    position = position_dodge(width = 1),
    vjust = 0, size = 4, fontface = "bold") +
  scale_y_continuous(expand = c(0, 1), limits = c(0,15), breaks = seq(0, 17.5, 2.5)) +
  theme_bw()+
  theme(
    panel.grid.major = element_line(color = "gray", size = 0.2, linetype = "dotted"),
    panel.grid.minor = element_line(color = "gray", size = 0.2, linetype = "dotted"),
    plot.title = element_text(hjust = 0.5),
    axis.title.x = element_blank(),
    # axis.text.x = element_blank(), to remove the x axis legend
    axis.line.x = element_blank(),
    axis.ticks.x = element_blank(),
    axis.text.y = element_text(size = 12, face = "bold"),
    panel.border = element_blank(),
    legend.position = "none",  # Move the legend to the top-left corner
    legend.justification = c(0, 1),  # Anchor the legend to the top-left corner
    legend.text = element_text(size = 12),  # Adjust the legend text size
    legend.title = element_text(size = 14)  # Adjust the legend title size
  )
gg_graph <- gg_graph + coord_flip()

plot.new()
print(gg_graph,newpage = FALSE)

# finaly details done using excell
write.csv(df_global, file = here(figures_output_dir,"Fig21-annualized_death_rate.csv"))


# Compare subgroups
print(df_global) # u see the dataframe used to build the graph
n = 1 # now i want to compare by 2 therefore i use this method

rate_comp <- ratedifference(df_global$event[n + 1], df_global$event[n], df_global$pyears[n + 1], df_global$pyears[n], CRC = TRUE, conf.level = 0.995)
value <- as.character(df_global$p.value)
result <- ifelse(df_global$p.value < 0.001 | df_global$p.value == 0, "<0.001", value)
print(result)
```
## Fig22-LGE-Forestplot
```{r Fig22-LGE-Forestplot}
library(forestplot)
# function
df_selected <- df_all %>%
  mutate(
    demo_age_categ = factor(case_when(
      demo_age < 65 ~ "age<65",
      TRUE ~ "age≥65"
    ), levels = c("age<65", "age≥65")),
    CMR_LVEF_categ = factor(ifelse(
      CMR_LVEF <= 40, "HFrEF", "HFmrEF"
    ), levels = c("HFrEF", "HFmrEF"))
  )

print("Forest plot")

D <- forest_function(
  df = df_selected, 
  time_var = "outcome_FU_time_death",
  event_var = "outcome_death",
  var_of_interest = "CMR_LGE_ischemic_presence",
  "demo_age_categ",
  "demo_gender",
  "CV_risk_obesity",
  "CV_risk_diabete",
  "CV_risk_HTA",
  "CV_risk_Smoking",
  "clini_NYHA",
  "CMR_LVEF_categ"
)

base_data <- D

name_row_vector <- c("Age","<65 years", "≥65 years", "Gender","Female", "Male", "Body Mass Index ","No obesity", "Obesity", "Diabete mellitus", "No", "Yes", "Hypertension", "No", "Yes", "Smoking", "No", "Yes", "Symptoms", "Asymptomatic","Symptomatic", "LVEF","≤40%", ">40%")

base_data$name <- name_row_vector

# Generate the forestplot
forest_plot <- base_data |>
  forestplot(
    labeltext = c(name, ratio1, ratio2, OR, Pval, PValInter), 
    graph.pos = 4,
    mean = mean,
    upper = upper,
    lower = lower,
    is.summary = FALSE, # c(rep(TRUE, 2), rep(c(TRUE, FALSE, FALSE), 8)), #Make Text Bold to highlight Summary rows
    boxsize = 0.2,  # Adjust the boxsize as needed) 
    clip = c(0, 7),  #Lower and upper limits for clipping confidence intervals to arrows
    align = c("r", "c", "c", "r","l", "l"), # make it work 
    vertices = TRUE,
    
    xlog = FALSE,  #Log scale on X axis 
    
    col = fpColors(box = "royalblue",
                    line = "darkblue",
                    summary = "royalblue")) |>

  fp_set_zebra_style("#EFEFEF", ignore_subheaders = FALSE)|>

  fp_set_style(box = "red",
               line = "gray0",
               summary = "royalblue",
               align = "lrrr")

print(forest_plot)
```

## Fig23-LGE-spline_curves
Encore des bug car HR de lui-même devrait être de 1 non ?
Ref = 3
```{r Fig23-LGE-spline_curves}
# Data
df_selected <- df_LGE

fit.cox = coxph(Surv(outcome_FU_time_death/12,outcome_death) ~ pspline(CMR_LGE_ischemic_extent_count), data = df_selected) # used median for 1 ...

## get predicted values for fitted spline
predicted = predict(fit.cox , type = "terms" , se.fit = TRUE , terms = 1, reference = "strata")


df_test <- data.frame(
  LGE_count = df_selected$CMR_LGE_ischemic_extent_count,
  HR = exp(predicted$fit),
  Upper_CI = exp(predicted$fit + 2.81 * predicted$se),
  Lower_CI = exp(predicted$fit - 2.81 * predicted$se)
  )

colnames(df_test) <- c("LGE_count","HR","Upper_CI","Lower_CI")

df_test <- as.data.frame(df_test)


# Plot using ggplot2
library(ggplot2)
gggraph <- ggplot(aes(x = LGE_count, y = HR), data=df_test) +
  geom_abline(slope = 0, intercept = 1, color = "black") +
  geom_vline(xintercept = 3, linetype = "dashed", size = 0.5, color = "black")+
  geom_smooth(method = "loess",color = "red", size = 0.7) +
  geom_ribbon(aes(ymin = predict(loess(Upper_CI ~ LGE_count, data = df_test)), 
                  ymax = predict(loess(Lower_CI ~ LGE_count, data = df_test))),
              fill = "orangered", alpha = 0.3) +
  
  labs(
    title = "Fig23-LGE-spline_curves",
    x = "Number of ischemic LGE segments",
    y = expression("Hazard Ratio for all-cause mortality n\ vs 3 segments of LGE (99.5% CI)")) +

  xlim(0, 8) +
  ylim(0, 40) +
  
  scale_y_continuous(breaks = c(1, 5, 10, 30)) +  # Y-axis marks at 1, 5, 10, 30
  scale_x_continuous(breaks = seq(0, 9, 1)) +  # X-axis marks every 1
  
  theme(
    panel.background = element_rect(fill = "white", color = NA),
    axis.line = element_line(color = "black"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.text.x = element_text(size = 16),  # Increase x-axis label font size
    axis.text.y = element_text(size = 16) 
  ) 
gggraph

# Save the plot in a folder 
ggsave(
  filename = here(figures_output_dir, paste0("Fig23-LGE-spline_curves-", Sys.Date(), ".png")), 
  plot = gggraph, width = 9, height = 6, units = "in", dpi = 600)
```